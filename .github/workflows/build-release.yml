name: Release + Build + Installer (Windows / macOS / Linux)

# Concurrency
concurrency:
  group: "pages"
  cancel-in-progress: true

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  QT_VERSION: "6.10.1"
  APP_NAME: "awsforwarder"        # change if different
  INSTALLER_ID: "de.jensvogt.awsforwarder" # used for IFW package path

permissions:
  contents: write       # required for tagging + releasing
  pull-requests: write
  id-token: write
  pages: write

jobs:
  release-please:
    name: Create Release PR / Tag
    runs-on: ubuntu-latest

    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.strip_tag.outputs.clean_tag }}

    steps:
      - name: Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          release-type: simple
          token: ${{ secrets.GH_AUTH_TOKEN }}

      - name: Strip leading 'v' from tag
        id: strip_tag
        run: |
          TAG="${{ steps.release.outputs.tag_name }}"
          CLEAN="${TAG#v}"   # remove leading 'v'
          echo "clean_tag=$CLEAN" >> $GITHUB_OUTPUT

  build-windows:
    name: Build & Package (Windows)
    runs-on: windows-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}

    env:
      APP_NAME: awsforwarder
      BUILD_DIR: ${{ github.workspace }}\build-windows
      INSTALLER_DIR: ${{ github.workspace }}\installer
      QT_DIR: ${{ github.workspace }}\Qt
      QT_VERSION: 6.10.1
      Qt6_DIR: ${{ github.workspace }}\Qt\6.10.1\msvc2022_64"
      VCPKG_ROOT: ${{ github.workspace }}\vcpkg
      SEMVER: ${{ needs.release-please.outputs.tag_name }}
      INSTALLER_ID: de.jensvogt.awsforwarder
      VCPKG_DEFAULT_TRIPLET: x64-windows

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # ------------------------
      # vcpkg (AWS SDK + yaml)
      # ------------------------
      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '66c0373dc7fca549e5803087b9487edfe3aca0a1'

      - name: Install vcpkg dependencies
        run: |
          vcpkg --vcpkg-root=${{env.VCPKG_ROOT}} install aws-sdk-cpp[core,secretsmanager,sts,eks]:${{env.VCPKG_DEFAULT_TRIPLET}}
          vcpkg --vcpkg-root=${{env.VCPKG_ROOT}} install yaml-cpp:${{env.VCPKG_DEFAULT_TRIPLET}}

      # ------------------------
      # Qt (prebuilt, FAST)
      # ------------------------
      - name: Install Qt & IFW
        shell: powershell
        run: |
          python -m pip install --upgrade pip
          python -m pip install aqtinstall
          python -m aqt install-qt windows desktop $env:QT_VERSION win64_msvc2022_64 --outputdir $env:QT_DIR --modules qtimageformats
          python -m aqt install-tool windows desktop tools_ifw --outputdir $env:QT_DIR

      # ------------------------
      # Configure + Build
      # ------------------------
      - name: Configure CMake
        shell: cmd
        run: |
          set "QT_PATH=C:\Qt\%QT_VERSION%\msvc2022_64"
          if not exist "%BUILD_DIR%" mkdir "%BUILD_DIR%"
          cmake -S . -B "%BUILD_DIR%" -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="%QT_PATH%" -DCMAKE_TOOLCHAIN_FILE="%VCPKG_ROOT%\scripts\buildsystems\vcpkg.cmake"

      - name: Build
        shell: powershell
        run: |
          cmake --build $env:BUILD_DIR --parallel

      # ------------------------
      # Package (windeployqt + IFW)
      # ------------------------
      - name: Deploy Qt runtime (windeployqt)
        shell: powershell
        run: |
          $exe = Join-Path $env:BUILD_DIR "$env:APP_NAME.exe"
          $dataDir = Join-Path $env:INSTALLER_DIR "packages\$env:INSTALLER_ID\data"
          New-Item -ItemType Directory -Path $dataDir -Force | Out-Null
          & "$env:QT_DIR\$env:QT_VERSION\msvc2022_64\bin\windeployqt6.exe" $exe --dir $dataDir
          Copy-Item $exe $dataDir
          Copy-Item dist\etc\awsforwarder_win32.json $dataDir\awsforwarder.json

      - name: Build Qt Installer Framework installer
        shell: powershell
        run: |
          $ifw = Get-ChildItem "$env:QT_DIR\Tools\QtInstallerFramework" -Directory | Sort-Object Name -Descending | Select-Object -First 1
          $env:PATH = "$($ifw.FullName)\bin;$env:PATH"
          binarycreator -c "$env:INSTALLER_DIR\config\config.xml" -p "$env:INSTALLER_DIR\packages" "$env:INSTALLER_DIR\$env:APP_NAME-$env:SEMVER-windows.exe"

      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: installer-windows
          path: installer/${{ env.APP_NAME }}-${{ env.SEMVER }}-windows.exe

      - name: Generate repository
        shell: powershell
        run: |
          $ifwRoot = Get-ChildItem "$env:QT_DIR\Tools\QtInstallerFramework" -Directory | Sort-Object Name -Descending | Select-Object -First 1
          if (-not $ifwRoot) { Write-Error "IFW not found"; exit 1 }
          $ifwBin = Join-Path $ifwRoot.FullName "bin"
          $env:PATH = "$ifwBin;$env:PATH"
          repogen -p installer/packages installer/repository

      - name: Upload repository artifact
        uses: actions/upload-artifact@v4
        with:
          name: repository
          path: installer/repository

  build-macos:
    name: Build & Package (macOS)
    runs-on: macos-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    env:
      BUILD_DIR: "${{ github.workspace }}/build-macos"
      SEMVER: "${{ needs.release-please.outputs.tag_name }}"
      INSTALLER_DIR: "${{ github.workspace }}/installer"
      APP_NAME: "awsforwarder"
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg
      VCPKG_DEFAULT_TRIPLET: x64-osx
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------
      # vcpkg (AWS SDK + yaml)
      # ------------------------
      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '66c0373dc7fca549e5803087b9487edfe3aca0a1'

      - name: Install vcpkg dependencies
        run: |
          vcpkg --vcpkg-root=${{env.VCPKG_ROOT}} install aws-sdk-cpp[core,secretsmanager,sts,eks]:${{env.VCPKG_DEFAULT_TRIPLET}}
          vcpkg --vcpkg-root=${{env.VCPKG_ROOT}} install yaml-cpp:${{env.VCPKG_DEFAULT_TRIPLET}}

      - name: Install Qt via aqtinstall
        shell: bash
        run: |
          python3 -m venv ~/venv
          source ~/venv/bin/activate
          python3 -m pip install --upgrade pip
          python3 -m pip install aqtinstall
          ARCH="clang_64"
          python3 -m aqt install-qt mac desktop 6.10.1 $ARCH --outputdir "$HOME/Qt" --modules qtcharts qtimageformats

      - name: Configure (macOS)
        shell: bash
        run: |
          mkdir -p $BUILD_DIR
          cmake -S . -B $BUILD_DIR -DCMAKE_BUILD_TYPE=Release -DQt6_DIR="$HOME/Qt/${{ env.QT_VERSION }}/macos/lib/cmake/Qt6" -DVCPKG_ROOT=${{ env.VCPKG_ROOT}} -DCMAKE_TOOLCHAIN_FILE=${{ env.VCPKG_ROOT }}/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=${{ env.VCPKG_DEFAULT_TRIPLET }} -DVCPKG_DISABLE_AUTO_PACKAGE_REGISTRATION=ON

      - name: Build (macOS)
        shell: bash
        run: |
          cmake --build $BUILD_DIR --config Release --parallel $(sysctl -n hw.logicalcpu)

      - name: Deploy Qt (macdeployqt)
        run: |
          macdeployqt build/awsforwarder.app -verbose=2

      - name: Create DMG
        run: |
          mkdir dmg
          cp -R build/awsforwarder.app dmg/
          hdiutil create awsforwarder.dmg -volname "AwsForwarder" -srcfolder dmg -ov -format UDZO

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: installer-macos
          path: dist/${{ env.APP_NAME }}-${{ env.SEMVER }}-macos.dmg

  build-linux-deb:
    name: Build & Package (Linux Debian package)
    runs-on: ubuntu-22.04
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    env:
      BUILD_DIR: "${{ github.workspace }}/build-linux"
      SEMVER: "${{ needs.release-please.outputs.tag_name }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Install dependencies
      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential cmake wget tar libfreetype6-dev libfontconfig1-dev libglib2.0-dev \
            ninja-build ruby ruby-dev libx11-dev libxext-dev libxrender-dev libcurl4-openssl-dev
          sudo gem install --no-document fpm

      - name: Get version
        id: get_version
        run: |
          CLEAN="${SEMVER#v}"
          echo "version=$CLEAN" >> $GITHUB_OUTPUT

      - name: Install Qt via install-qt-action
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          modules: "qtcharts qtimageformats"
          install-deps: true

      - name: Configure (Linux)
        shell: bash
        run: |
          mkdir -p $BUILD_DIR
          cmake -S . -B $BUILD_DIR -DCMAKE_BUILD_TYPE=Release

      - name: Build (Linux)
        shell: bash
        run: |
          cmake --build $BUILD_DIR --parallel $(nproc)

      # Step 5: Prepare the .deb package directory
      - name: Prepare package structure
        run: |
          PACKAGE_DIR=package
          echo "PACKAGE_DIR=$PACKAGE_DIR" >> $GITHUB_ENV
          
          mkdir -p $PACKAGE_DIR/DEBIAN
          mkdir -p $PACKAGE_DIR/usr/local/awsforwarder/bin
          mkdir -p $PACKAGE_DIR/usr/local/awsforwarder/etc
          mkdir -p $PACKAGE_DIR/usr/local/awsforwarder/log
          mkdir -p $PACKAGE_DIR/usr/local/awsforwarder/lib
          mkdir -p $PACKAGE_DIR/usr/local/awsforwarder/plugins
          mkdir -p $PACKAGE_DIR/usr/local/awsforwarder/translations
          
          # Copy your app
          cp $BUILD_DIR/${APP_NAME} $PACKAGE_DIR/usr/local/awsforwarder/bin/
          cp -r $QT_ROOT_DIR/lib/* $PACKAGE_DIR/usr/local/awsforwarder/lib
          cp -r $QT_ROOT_DIR/plugins/platforms $PACKAGE_DIR/usr/local/awsforwarder/plugins/
          cp -r $QT_ROOT_DIR/plugins/imageformats $PACKAGE_DIR/usr/local/awsforwarder/plugins/
          cp -r dist/etc/${APP_NAME}.json $PACKAGE_DIR/usr/local/awsforwarder/etc
          
          # Create Qt conf
          cat << EOF > $PACKAGE_DIR/usr/local/awsforwarder/bin/qt.conf
          [Paths]
          Prefix = ..
          EOF

      # Step 6: Build the .deb package
      - name: Build DEB with fpm
        run: |
          fpm -s dir -t deb --name "${APP_NAME}" --version "${SEMVER}" --architecture amd64 --package "${APP_NAME}-${SEMVER}-amd64.deb" -C "$PACKAGE_DIR" usr/local/$APP_NAME

      # Step 7: Upload .deb artifact
      - name: Upload .deb
        uses: actions/upload-artifact@v4
        with:
          name: deb-package-linux
          path: ${{ env.APP_NAME }}-${{ env.SEMVER }}-amd64.deb

  build-linux-rpm:
    name: Build & Package (Linux RPM package)
    runs-on: ubuntu-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    env:
      APP_NAME: awsforwarder
      BUILD_DIR: "${{ github.workspace }}/build-linux"
      SEMVER: "${{ needs.release-please.outputs.tag_name }}"

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential cmake ninja-build ruby ruby-dev libcurl4-openssl-dev
          sudo gem install --no-document fpm

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          modules: qtcharts qtimageformats
          install-deps: true

      - name: Configure & Build
        run: |
          mkdir -p $BUILD_DIR
          cmake -S . -B $BUILD_DIR -DCMAKE_BUILD_TYPE=Release
          cmake --build $BUILD_DIR --parallel $(nproc)

      - name: Prepare Linux package folder
        run: |
          PACKAGE_DIR=package
          echo "PACKAGE_DIR=$PACKAGE_DIR" >> $GITHUB_ENV
          
          mkdir -p $PACKAGE_DIR/usr/local/$APP_NAME/bin
          mkdir -p $PACKAGE_DIR/usr/local/$APP_NAME/etc
          mkdir -p $PACKAGE_DIR/usr/local/$APP_NAME/lib
          mkdir -p $PACKAGE_DIR/usr/local/$APP_NAME/plugins
          
          # FIX: correct binary path
          cp $BUILD_DIR/$APP_NAME $PACKAGE_DIR/usr/local/$APP_NAME/bin/
          
          cp dist/etc/$APP_NAME.json $PACKAGE_DIR/usr/local/$APP_NAME/etc/
          cp -r $QT_ROOT_DIR/lib/* $PACKAGE_DIR/usr/local/$APP_NAME/lib/
          cp -r $QT_ROOT_DIR/plugins/platforms $PACKAGE_DIR/usr/local/$APP_NAME/plugins/
          cp -r $QT_ROOT_DIR/plugins/imageformats $PACKAGE_DIR/usr/local/$APP_NAME/plugins/
          
          cat << EOF > $PACKAGE_DIR/usr/local/$APP_NAME/bin/qt.conf
          [Paths]
          Prefix = ..
          EOF

      - name: Build RPM with fpm
        run: |
          fpm -s dir -t rpm --name "${APP_NAME}" --version "${SEMVER}" --architecture amd64 --package "${APP_NAME}-${SEMVER}-amd64.rpm" -C "$PACKAGE_DIR" usr/local/$APP_NAME

      - name: Upload RPM
        uses: actions/upload-artifact@v4
        with:
          name: rpm-package-linux
          path: ${{ env.APP_NAME }}-${{ env.SEMVER }}-amd64.rpm

  # ====================================================================================================================
  # build-macos, build-linux-rpm, build-linux-deb
  # ====================================================================================================================
  publish:
    name: Publish Release & Attach Installers
    runs-on: ubuntu-latest
    needs: [ release-please, build-windows ]

    env:
      SEMVER: "${{ needs.release-please.outputs.tag_name }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Windows installer
        uses: actions/download-artifact@v4
        with:
          name: installer-windows
          path: artifacts/windows

      #      - name: Download macOS installer
      #        uses: actions/download-artifact@v4
      #        with:
      #          name: installer-macos
      #          path: artifacts/macos
      #
      #      - name: Download Linux Debian package
      #        uses: actions/download-artifact@v4
      #        with:
      #          name: deb-package-linux
      #          path: artifacts/linux
      #
      #      - name: Download Linux RPM package
      #        uses: actions/download-artifact@v4
      #        with:
      #          name: rpm-package-linux
      #          path: artifacts/linux

      - name: Download Windows Updates
        uses: actions/download-artifact@v4
        with:
          name: repository
          path: artifacts/repository

      - name: Create GitHub Release (attach installers)
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/windows/*.exe
            artifacts/macos/*.dmg
            artifacts/linux/*.deb
            artifacts/linux/*.rpm
            artifacts/repository/*
          name: Release ${{ env.SEMVER }}
          tag_name: ${{ env.SEMVER }}
          body: "Automated release for ${{ env.SEMVER }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_AUTH_TOKEN }}

  deploy:
    needs:
      - publish
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create site folder
        run: |
          mkdir public
          cp ./artifacts/installer-windows/*.exe public/ || true
          cp ./artifacts/installer-macos/*.dmg public/ || true
          cp ./artifacts/deb-package-linux/*.deb public/ || true
          cp ./artifacts/rpm-package-linux/*.rpm public/ || true
          cp -r ./artifacts/repository/* public/ || true
          cp .github/pages/index.html public/index.html || true
          find . -ls

      - name: Generate files.json
        run: |
          cd public
          echo '{ "downloads": [' > files.json
          first=true
          for f in *.{exe,deb,rpm,dmg}; do
            [ -f "$f" ] || continue
            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> files.json
            fi
            size=$(stat -c%s "$f")
            sha=$(sha256sum "$f" | cut -d" " -f1)
            echo "  {\"file\": \"$f\", \"size\": $size, \"sha256\": \"$sha\"}" >> files.json
          done
          echo "]}" >> files.json

      - name: Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4